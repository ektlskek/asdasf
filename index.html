<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>과외 기록</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuq4sOyWhCDtlZnsg50g6rSA66asIiwKICAic2hvcnRfbmFtZSI6ICLqs7XsmbjqtIA66asiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiM0Qjc5QTEiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhPVElpSUdobGFXZG9kRDBpTVRreUlpQjJhV1YzUW05NFBTSXdJREFnTVRreUlERTVNaUkrUEhKbFkzUWdlRDBpTWpRaUlIazlJakkwSWlCM2FXUjBhRDBpTVRRMElpQm9aV2xuYUhROUlURTBOQ0lnWm1sc2JEMGlJelJDTnpsQk1TSXZQanh3WVhSb0lHUTlJazB5TkNBMk5FZ3hOamdXMEZWRUdGbE9UREVPVEF6TkVoeU9UUXpTRE0wT1ZaUk0wZGhWalZVT1dwSGVrOTJhWGgzV21aa2MzVklNVm9pSUdacGJHdzlJaU0zTmpoQ05rRWlMejQ4TDNOMlp6ND0iLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="과외기록">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiB2aWV3Qm94PSIwIDAgMTgwIDE4MCI+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIGZpbGw9IiM0Qjc5QTEiLz48cGF0aCBkPSJNMjQgNjRIMTU2VjEyOEgyNFY2NFoiIGZpbGw9IiM3NjhCNkEiLz48L3N2Zz4=">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f7; color: #1d1d1f; user-select: none; -webkit-user-select: none; overflow-x: hidden; }
        .app-container { min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: linear-gradient(135deg, #4B79A1 0%, #283E51 100%); color: white; padding: 60px 20px 20px; text-align: center; box-shadow: 0 2px 20px rgba(0,0,0,0.1); }
        .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .tab-navigation { display: flex; background: white; border-bottom: 1px solid #e5e5e7; position: sticky; top: 0; z-index: 100; }
        .tab-button { flex: 1; padding: 16px; background: none; border: none; font-size: 16px; font-weight: 600; color: #86868b; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .tab-button.active { color: #4B79A1; }
        .tab-button.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: #4B79A1; border-radius: 2px 2px 0 0; }
        .content { flex: 1; padding: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .calendar-container { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-nav { background: none; border: none; font-size: 24px; color: #4B79A1; cursor: pointer; padding: 8px; border-radius: 50%; transition: background 0.2s; }
        .calendar-nav:hover { background: #f0f0f0; }
        .calendar-title { font-size: 20px; font-weight: 700; color: #1d1d1f; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e5e7; border-radius: 8px; overflow: hidden; }
        .calendar-day-header { background: #f5f5f7; padding: 12px 4px; text-align: center; font-weight: 600; font-size: 14px; color: #86868b; }
        .calendar-day { background: white; padding: 4px; text-align: center; cursor: pointer; transition: all 0.2s; min-height: 52px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; position: relative; font-size: 14px; }
        .calendar-day:hover { background: #f0f8ff; }
        .calendar-day.selected { background: #e3eef7; outline: 2px solid #4B79A1; border-radius: 4px; }
        .calendar-day.selected .day-number { font-weight: 700; }
        .calendar-day.today .day-number { background: #ff3b30; color: white; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; }
        .class-dots { display: flex; flex-wrap: wrap; justify-content: center; gap: 3px; margin-top: 4px; max-width: 35px; }
        .class-dot { width: 5px; height: 5px; border-radius: 50%; }
        .filter-container { margin-bottom: 20px; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .filter-container select { width: 100%; padding: 10px; border: 1px solid #d2d2d7; border-radius: 8px; font-size: 16px; background-color: white; }
        .scheduled-classes-container { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .scheduled-classes-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .scheduled-classes-header h3 { font-size: 20px; color: #1d1d1f; }
        .btn-primary { background: #4B79A1; color: white; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .btn-primary:hover { background: #3a6289; }
        .btn-primary.danger { background-color: #c94040; }
        .class-item { display: flex; flex-direction: column; padding: 12px; border-bottom: 1px solid #e5e5e7; border-left: 5px solid transparent; margin: 4px 0; border-radius: 4px; background-color: #fafafa; }
        .class-item:last-child { border-bottom: none; }
        .class-item-main { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .class-info-group { display: flex; flex-direction:column; align-items: flex-start; gap: 4px; }
        .class-time { font-weight: 600; color: #4B79A1; }
        .class-student-list { font-size: 15px; color: #1d1d1f; }
        .class-item-actions { display: flex; gap: 8px; }
        .class-item-details { padding: 12px 0 4px 0; width: 100%; border-top: 1px dashed #e0e0e0; margin-top: 12px; font-size: 14px; line-height: 1.5; }
        .detail-section { color: #555; word-break: break-all; }
        .detail-section strong { color: #1d1d1f; }
        .detail-section + .detail-section { margin-top: 8px; }
        .no-class-msg { text-align: center; color: #86868b; padding: 20px 0; }
        .student-header, .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .student-header h2, .settings-header h2 { font-size: 24px; color: #1d1d1f; }
        .student-list, .settings-list { display: grid; gap: 16px; }
        .student-card, .settings-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .student-card { transition: transform 0.2s, box-shadow 0.2s; border-left: 6px solid; }
        .student-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
        .student-info h3 { font-size: 18px; color: #1d1d1f; margin-bottom: 8px; }
        .student-details { color: #86868b; font-size: 14px; line-height: 1.6; }
        .student-actions { margin-top: 12px; display: flex; gap: 8px; }
        .btn-small { padding: 6px 12px; font-size: 12px; border: 1px solid #d2d2d7; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .btn-small:hover { background: #f5f5f7; }
        .btn-small.danger { color: #ff3b30; border-color: #ff3b30; }
        .btn-small.danger:hover { background: #fff5f5; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 24px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #86868b; }
        .form-group { margin-bottom: 16px; }
        .form-group.hidden { display: none; }
        .form-label { display: block; font-weight: 600; margin-bottom: 6px; color: #1d1d1f; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px; font-size: 16px; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #4B79A1; }
        textarea.form-input { min-height: 80px; line-height: 1.5; }
        .form-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        .btn-cancel { padding: 12px 20px; background: white; border: 1px solid #d2d2d7; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-submit { padding: 12px 20px; background: #4B79A1; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .billing-status { margin-top: 12px; }
        .monthly-class-count { font-size: 15px; font-weight: 500; text-align: right; }
        .progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 8px; height: 20px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; background-color: #4B79A1; border-radius: 8px 0 0 8px; transition: width 0.4s ease; }
        .progress-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #1d1d1f; font-weight: 600; font-size: 12px; }
        .billing-warning { margin-top: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; }
        .warning-text { color: #856404; font-size: 14px; font-weight: bold; margin-bottom: 8px; }
        .payment-checkbox-label { display: flex; align-items: center; cursor: pointer; font-size: 14px; }
        .payment-checkbox { margin-right: 8px; transform: scale(1.2); }
        .student-checkbox-container { max-height: 150px; overflow-y: auto; border: 1px solid #d2d2d7; border-radius: 8px; padding: 8px; }
        .student-checkbox-item { display: flex; align-items: center; padding: 8px; }
        .student-checkbox-item:not(:last-child) { border-bottom: 1px solid #f0f0f0; }
        .student-checkbox-item input { margin-right: 12px; transform: scale(1.2); }
        .settings-card p { font-size: 14px; color: #86868b; margin: 8px 0 12px 0; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>과외 기록</h1>
            <p>진행한 수업을 기록하고 관리하세요</p>
        </div>

        <div class="tab-navigation">
            <button class="tab-button active" data-tab="calendar" id="calendarTabButton">캘린더</button>
            <button class="tab-button" data-tab="students" id="studentsTabButton">학생 관리</button>
            <button class="tab-button" data-tab="settings" id="settingsTabButton">설정</button>
        </div>

        <div class="content">
            <div id="calendar" class="tab-content active">
                <div class="filter-container">
                    <select id="studentFilter"></select>
                </div>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" id="prevMonth">‹</button>
                        <div class="calendar-title" id="currentMonth"></div>
                        <button class="calendar-nav" id="nextMonth">›</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>

                <div class="scheduled-classes-container">
                    <div class="scheduled-classes-header">
                        <h3 id="scheduledClassesTitle">오늘의 수업 기록</h3>
                        <button class="btn-primary" id="addClassBtn">+ 수업 기록</button>
                    </div>
                    <div id="scheduledClassesList"></div>
                </div>
            </div>

            <div id="students" class="tab-content">
                <div class="student-header">
                    <h2>학생 관리</h2>
                    <button class="btn-primary" id="addStudentBtn">+ 학생 추가</button>
                </div>
                <div class="student-list" id="studentList"></div>
            </div>

            <div id="settings" class="tab-content">
                <div class="settings-header">
                    <h2>설정</h2>
                </div>
                <div class="settings-list">
                    <div class="settings-card">
                        <h3>데이터 백업 (내보내기)</h3>
                        <p>모든 학생 및 수업 기록을 하나의 파일로 저장합니다. 기기를 바꾸거나 만약을 대비해 정기적으로 백업하는 것을 권장합니다.</p>
                        <button id="exportDataBtn" class="btn-primary">데이터 내보내기</button>
                    </div>
                    <div class="settings-card">
                        <h3>데이터 복원 (가져오기)</h3>
                        <p>백업 파일에서 데이터를 복원합니다. <strong style="color: #c94040;">주의: 현재 모든 기록이 선택한 파일의 내용으로 대체됩니다!</strong></p>
                        <input type="file" id="importDataInput" accept=".json, .txt" style="display: none;">
                        <button id="importDataBtn" class="btn-primary danger">데이터 가져오기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="studentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="studentModalTitle">학생 추가</h3>
                <button class="close-btn" data-modal="studentModal">&times;</button>
            </div>
            <form id="studentForm">
                <div class="form-group">
                    <label class="form-label">이름</label>
                    <input type="text" class="form-input" id="studentName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">과목</label>
                    <input type="text" class="form-input" id="studentSubject" required>
                </div>
                 <div class="form-group">
                    <label class="form-label">정산 방식</label>
                    <select id="paymentMethod" class="form-input" required>
                        <option value="session">횟수별 정산</option>
                        <option value="monthly">월별 정산</option>
                    </select>
                </div>
                <div class="form-group hidden" id="sessionCycleGroup">
                    <label class="form-label">기준 횟수 (예: 4, 8)</label>
                    <input type="number" class="form-input" id="sessionCycle" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">수업료</label>
                    <input type="number" class="form-input" id="studentFee">
                </div>
                <div class="form-group">
                    <label class="form-label">학년</label>
                    <input type="text" class="form-input" id="studentGrade">
                </div>
                <div class="form-group">
                    <label class="form-label">연락처</label>
                    <input type="tel" class="form-input" id="studentPhone">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" data-modal="studentModal">취소</button>
                    <button type="submit" class="btn-submit">저장</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="classModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="classModalTitle">수업 기록 추가</h3>
                <button class="close-btn" data-modal="classModal">&times;</button>
            </div>
            <form id="classForm">
                <input type="hidden" id="classDate">
                <div class="form-group">
                    <label class="form-label">학생 (복수 선택 가능)</label>
                    <div id="classStudentCheckboxes" class="student-checkbox-container"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">수업 시간</label>
                    <input type="time" class="form-input" id="classTime" required>
                </div>
                <div class="form-group">
                    <label class="form-label">수업 메모</label>
                    <textarea id="classMemo" class="form-input" placeholder="수업 내용, 학생의 상태 등 자유롭게 기록하세요."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">숙제</label>
                    <textarea id="classHomework" class="form-input" placeholder="내준 숙제를 기록하세요."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" data-modal="classModal">취소</button>
                    <button type="submit" class="btn-submit">저장</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let students = [];
            let classes = [];
            let currentDate = new Date();
            let selectedDate = null;
            let currentEditingStudentId = null;
            let currentEditingClassId = null;

            const G_COLOR_PALETTE = ['#FFADAD', '#FFD6A5', '#FDFFB6', '#CAFFBF', '#9BF6FF', '#A0C4FF', '#BDB2FF', '#FFC6FF'];

            const getEl = (id) => document.getElementById(id);
            const queryAll = (selector) => document.querySelectorAll(selector);

            const tabButtons = queryAll('.tab-button');
            const tabContents = queryAll('.tab-content');
            const calendarGrid = getEl('calendarGrid');
            const currentMonthElement = getEl('currentMonth');
            const studentFilter = getEl('studentFilter');
            const scheduledClassesTitle = getEl('scheduledClassesTitle');
            const scheduledClassesList = getEl('scheduledClassesList');
            const studentList = getEl('studentList');
            const studentModal = getEl('studentModal');
            const classModal = getEl('classModal');
            const studentForm = getEl('studentForm');
            const classForm = getEl('classForm');
            const paymentMethodSelect = getEl('paymentMethod');
            const sessionCycleGroup = getEl('sessionCycleGroup');
            const exportDataBtn = getEl('exportDataBtn');
            const importDataBtn = getEl('importDataBtn');
            const importDataInput = getEl('importDataInput');

            const saveData = () => {
                localStorage.setItem('tutoring_log_students_v5', JSON.stringify(students));
                localStorage.setItem('tutoring_log_classes_v5', JSON.stringify(classes));
            };

            const loadData = () => {
                students = JSON.parse(localStorage.getItem('tutoring_log_students_v5')) || [];
                classes = JSON.parse(localStorage.getItem('tutoring_log_classes_v5')) || [];
            };

            const renderStudentFilter = () => {
                const currentFilterValue = studentFilter.value;
                studentFilter.innerHTML = `<option value="all">모든 학생</option>`;
                students.forEach(s => {
                    studentFilter.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });
                studentFilter.value = currentFilterValue || 'all';
            };

            const updateCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const selectedFilterId = studentFilter.value;
                
                currentMonthElement.textContent = `${year}년 ${month + 1}월`;
                
                const dayHeaders = ['일', '월', '화', '수', '목', '금', '토'];
                calendarGrid.innerHTML = dayHeaders.map(day => `<div class="calendar-day-header">${day}</div>`).join('');

                let dayCounter = new Date(year, month, 1);
                dayCounter.setDate(dayCounter.getDate() - dayCounter.getDay());
                
                const today = new Date();
                
                for (let i = 0; i < 42; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.classList.add('calendar-day');
                    const dateStr = `${dayCounter.getFullYear()}-${String(dayCounter.getMonth() + 1).padStart(2, '0')}-${String(dayCounter.getDate()).padStart(2, '0')}`;
                    dayDiv.dataset.date = dateStr;

                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = dayCounter.getDate();
                    dayDiv.appendChild(dayNumber);

                    if (dayCounter.getMonth() !== month) dayDiv.style.opacity = "0.4";
                    if (dayCounter.toDateString() === today.toDateString()) dayDiv.classList.add('today');
                    if (selectedDate && dayCounter.toDateString() === selectedDate.toDateString()) dayDiv.classList.add('selected');
                    
                    let sessionsOnThisDay = classes.filter(c => c.date === dateStr);
                    if (selectedFilterId !== 'all') {
                        sessionsOnThisDay = sessionsOnThisDay.filter(c => c.studentIds.includes(Number(selectedFilterId)));
                    }

                    if (sessionsOnThisDay.length > 0) {
                        const dotsContainer = document.createElement('div');
                        dotsContainer.className = 'class-dots';
                        const studentIdsOnThisDay = sessionsOnThisDay.flatMap(c => c.studentIds);
                        const uniqueStudentIds = [...new Set(studentIdsOnThisDay)];
                        
                        uniqueStudentIds.slice(0, 5).forEach(studentId => {
                            const student = students.find(s => s.id === studentId);
                            if (student) {
                                const dot = document.createElement('div');
                                dot.className = 'class-dot';
                                dot.style.backgroundColor = student.color;
                                dotsContainer.appendChild(dot);
                            }
                        });
                        dayDiv.appendChild(dotsContainer);
                    }
                    calendarGrid.appendChild(dayDiv);
                    dayCounter.setDate(dayCounter.getDate() + 1);
                }
            };
            
            const renderClassesForDate = (date) => {
                selectedDate = date;
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const selectedFilterId = studentFilter.value;
                const today = new Date();
                if (date.toDateString() === today.toDateString()) scheduledClassesTitle.textContent = '오늘의 수업 기록';
                else scheduledClassesTitle.textContent = `${date.getMonth() + 1}월 ${date.getDate()}일의 기록`;
                
                let sessionsOnThisDay = classes.filter(c => c.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));
                if (selectedFilterId !== 'all') {
                    sessionsOnThisDay = sessionsOnThisDay.filter(c => c.studentIds.includes(Number(selectedFilterId)));
                }

                if (sessionsOnThisDay.length === 0) {
                    scheduledClassesList.innerHTML = `<div class="no-class-msg">수업 기록을 추가해 주세요.</div>`;
                } else {
                    scheduledClassesList.innerHTML = sessionsOnThisDay.map(c => {
                        const participatingStudents = students.filter(s => c.studentIds.includes(s.id));
                        if (participatingStudents.length === 0) return '';
                        
                        const studentNames = participatingStudents.map(s => s.name).join(', ');
                        const memoHtml = c.memo ? c.memo.replace(/\n/g, '<br>') : '';
                        const homeworkHtml = c.homework ? c.homework.replace(/\n/g, '<br>') : '';

                        return `
                            <div class="class-item" style="border-left-color: ${participatingStudents[0].color};">
                                <div class="class-item-main">
                                    <div class="class-info-group">
                                        <div class="class-time">${c.time}</div>
                                        <div class="class-student-list">${studentNames}</div>
                                    </div>
                                    <div class="class-item-actions">
                                        <button class="btn-small edit-class" data-class-id="${c.id}">수정</button>
                                        <button class="btn-small danger" data-class-id="${c.id}">삭제</button>
                                    </div>
                                </div>
                                ${ (c.memo || c.homework) ? `
                                <div class="class-item-details">
                                    ${c.memo ? `<div class="detail-section"><strong>메모:</strong> ${memoHtml}</div>` : ''}
                                    ${c.homework ? `<div class="detail-section"><strong>숙제:</strong> ${homeworkHtml}</div>` : ''}
                                </div>
                                ` : '' }
                            </div>
                        `;
                    }).join('');
                }
                updateCalendar();
            };

            const renderStudents = () => {
                const today = new Date();
                students.forEach(student => {
                    if (student.paymentMethod === 'monthly') {
                        const lastMonthDate = new Date(today.getFullYear(), today.getMonth(), 0); 
                        const lastMonthYear = lastMonthDate.getFullYear();
                        const lastMonthMonth = lastMonthDate.getMonth();
                        
                        const isAlreadyUnpaid = student.unpaidMonths.some(m => m.year === lastMonthYear && m.month === lastMonthMonth);

                        if (!isAlreadyUnpaid) {
                            const classesInLastMonth = classes.filter(c => {
                                const classDate = new Date(c.date.replace(/-/g, '/'));
                                return c.studentIds.includes(student.id) && classDate.getFullYear() === lastMonthYear && classDate.getMonth() === lastMonthMonth;
                            }).length;

                            if(classesInLastMonth > 0) {
                                student.unpaidMonths.push({ year: lastMonthYear, month: lastMonthMonth, classCount: classesInLastMonth });
                            }
                        }
                    }
                });
                saveData();


                studentList.innerHTML = '';
                if (students.length === 0) {
                    studentList.innerHTML = `<div class="no-class-msg">등록된 학생이 없습니다.</div>`;
                    return;
                }
                students.forEach(student => {
                    const studentCard = document.createElement('div');
                    studentCard.className = 'student-card';
                    studentCard.style.borderColor = student.color;

                    let billingStatusHTML = '';
                    let billingWarningHTML = '';

                    if (student.paymentMethod === 'session') {
                        const cycle = student.sessionCycle || 1;
                        const count = student.totalClassesCount || 0;
                        const overdueCycles = count >= cycle ? Math.floor(count / cycle) : 0;
                        const currentInCycle = count % cycle;
                        const progressPercent = cycle > 0 ? (currentInCycle / cycle * 100) : 0;

                        billingStatusHTML = `
                            <div class="billing-status">
                                <div class="progress-bar-container">
                                    <div class="progress-bar" style="width: ${progressPercent}%;"></div>
                                    <div class="progress-text">${currentInCycle} / ${cycle} (총 ${count}회)</div>
                                </div>
                            </div>
                        `;
                        if (overdueCycles > 0) {
                            billingWarningHTML = `
                                <div class="billing-warning">
                                    <div class="warning-text">${overdueCycles}회분 수업료가 밀렸습니다.</div>
                                    <label class="payment-checkbox-label">
                                        <input type="checkbox" class="payment-checkbox" data-student-id="${student.id}"> 수업료 받음 (1회분 정산)
                                    </label>
                                </div>`;
                        }
                    } else { // monthly
                        const classesThisMonth = classes.filter(c => {
                            const classDate = new Date(c.date.replace(/-/g, '/'));
                            return c.studentIds.includes(student.id) && classDate.getFullYear() === today.getFullYear() && classDate.getMonth() === today.getMonth();
                        }).length;

                        billingStatusHTML = `<div class="billing-status"><div class="monthly-class-count">이번 달 총 ${classesThisMonth}회 수업</div></div>`;

                        if (student.unpaidMonths && student.unpaidMonths.length > 0) {
                            const totalUnpaidClasses = student.unpaidMonths.reduce((sum, m) => sum + m.classCount, 0);
                            billingWarningHTML = `
                                <div class="billing-warning">
                                    <div class="warning-text">${student.unpaidMonths.length}개월분 (${totalUnpaidClasses}회) 수업료가 밀렸습니다.</div>
                                    <label class="payment-checkbox-label">
                                        <input type="checkbox" class="payment-checkbox" data-student-id="${student.id}"> 수업료 받음 (가장 오래된 1개월분 정산)
                                    </label>
                                </div>`;
                        }
                    }

                    const paymentText = student.paymentMethod === 'session' ? `횟수별 (${student.sessionCycle || '미설정'}회)` : '월별';
                    studentCard.innerHTML = `
                        <div class="student-info">
                            <h3>${student.name}</h3>
                            <div class="student-details">
                                <div>과목: ${student.subject}</div>
                                <div>정산: ${paymentText}</div>
                            </div>
                            ${billingStatusHTML}
                            ${billingWarningHTML}
                        </div>
                        <div class="student-actions">
                            <button class="btn-small edit-student" data-id="${student.id}">편집</button>
                            <button class="btn-small danger delete-student" data-id="${student.id}">삭제</button>
                        </div>
                    `;
                    studentList.appendChild(studentCard);
                });
            };

            const openModal = (modalElement) => modalElement.classList.add('show');
            const closeModal = (modalElement) => modalElement.classList.remove('show');

            const openStudentModal = (studentId = null) => {
                currentEditingStudentId = studentId;
                studentForm.reset();
                if (studentId) {
                    const student = students.find(s => s.id === studentId);
                    getEl('studentModalTitle').textContent = '학생 편집';
                    getEl('studentName').value = student.name;
                    getEl('studentSubject').value = student.subject;
                    getEl('paymentMethod').value = student.paymentMethod;
                    if(student.paymentMethod === 'session') getEl('sessionCycle').value = student.sessionCycle;
                    getEl('studentFee').value = student.fee;
                    getEl('studentGrade').value = student.grade;
                    getEl('studentPhone').value = student.phone;
                } else {
                    getEl('studentModalTitle').textContent = '학생 추가';
                }
                paymentMethodSelect.dispatchEvent(new Event('change'));
                openModal(studentModal);
            };

            const openClassModal = (classId = null) => {
                classForm.reset();
                currentEditingClassId = classId;

                const checkboxesContainer = getEl('classStudentCheckboxes');
                checkboxesContainer.innerHTML = students.map(s => `
                    <div class="student-checkbox-item">
                        <input type="checkbox" value="${s.id}" id="student-cb-${s.id}">
                        <label for="student-cb-${s.id}">${s.name} (${s.subject})</label>
                    </div>
                `).join('');

                if (classId) { // Editing existing class
                    getEl('classModalTitle').textContent = '수업 기록 수정';
                    const classToEdit = classes.find(c => c.id === classId);
                    getEl('classTime').value = classToEdit.time;
                    getEl('classMemo').value = classToEdit.memo;
                    getEl('classHomework').value = classToEdit.homework;
                    classToEdit.studentIds.forEach(studentId => {
                        const checkbox = getEl(`student-cb-${studentId}`);
                        if (checkbox) checkbox.checked = true;
                    });
                } else { // Adding new class
                    if (!selectedDate) {
                        alert('먼저 캘린더에서 날짜를 선택해주세요.');
                        return;
                    }
                    if (students.length === 0) {
                        alert('먼저 학생을 등록해주세요.');
                        activateTab('students');
                        return;
                    }
                    getEl('classModalTitle').textContent = '수업 기록 추가';
                    getEl('classDate').value = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
                }
                
                openModal(classModal);
            };
            
            const activateTab = (tabName) => {
                tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
                tabContents.forEach(content => content.classList.toggle('active', content.id === tabName));
                if(tabName === 'students') renderStudents();
            };

            const initializeApp = () => {
                loadData();
                const today = new Date();
                selectedDate = today;
                renderStudentFilter();
                renderStudents(); 
                updateCalendar();
                renderClassesForDate(today);
            };

            // --- Event Listeners ---
            tabButtons.forEach(button => button.addEventListener('click', () => activateTab(button.dataset.tab)));
            getEl('prevMonth').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); updateCalendar(); });
            getEl('nextMonth').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); updateCalendar(); });
            calendarGrid.addEventListener('click', (e) => {
                const dayDiv = e.target.closest('.calendar-day');
                if (dayDiv && dayDiv.dataset.date) renderClassesForDate(new Date(dayDiv.dataset.date.replace(/-/g, '/')));
            });
            studentFilter.addEventListener('change', () => renderClassesForDate(selectedDate));
            getEl('addStudentBtn').addEventListener('click', () => openStudentModal());
            getEl('addClassBtn').addEventListener('click', () => openClassModal());

            studentList.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('edit-student')) openStudentModal(Number(target.dataset.id));
                if (target.classList.contains('delete-student')) {
                    const studentId = Number(target.dataset.id);
                    if (confirm('정말로 이 학생을 삭제하시겠습니까?\n해당 학생의 모든 수업 기록이 함께 삭제됩니다.')) {
                        students = students.filter(s => s.id !== studentId);
                        classes = classes.map(c => {
                            c.studentIds = c.studentIds.filter(id => id !== studentId);
                            return c;
                        }).filter(c => c.studentIds.length > 0);
                        saveData();
                        initializeApp();
                    }
                }
                if (target.classList.contains('payment-checkbox')) {
                    const studentId = Number(target.dataset.studentId);
                    const student = students.find(s => s.id === studentId);
                    if (student.paymentMethod === 'session') {
                        if(student.totalClassesCount >= student.sessionCycle) {
                           student.totalClassesCount -= student.sessionCycle;
                        }
                    } else {
                        student.unpaidMonths.shift();
                    }
                    saveData();
                    renderStudents();
                    target.checked = false;
                }
            });
            
            scheduledClassesList.addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('.edit-class')) {
                    openClassModal(Number(target.dataset.classId));
                }
                if (target.matches('.danger')) { // Delete button
                    const classId = Number(target.dataset.classId);
                    const classToDelete = classes.find(c => c.id === classId);
                    if (classToDelete) {
                        classToDelete.studentIds.forEach(studentId => {
                            const student = students.find(s => s.id === studentId);
                            if (student && student.paymentMethod === 'session') {
                                student.totalClassesCount = Math.max(0, (student.totalClassesCount || 0) - 1);
                            }
                        });
                    }
                    classes = classes.filter(c => c.id !== classId);
                    saveData();
                    renderClassesForDate(selectedDate);
                    renderStudents();
                }
            });

            paymentMethodSelect.addEventListener('change', () => {
                sessionCycleGroup.classList.toggle('hidden', paymentMethodSelect.value !== 'session');
            });
            
            studentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const paymentMethod = getEl('paymentMethod').value;
                const sessionCycle = getEl('sessionCycle').value;

                if (paymentMethod === 'session' && (!sessionCycle || sessionCycle < 1)) {
                    alert('횟수별 정산은 기준 횟수를 1 이상으로 입력해야 합니다.');
                    return;
                }

                const formData = {
                    name: getEl('studentName').value,
                    subject: getEl('studentSubject').value,
                    grade: getEl('studentGrade').value,
                    phone: getEl('studentPhone').value,
                    paymentMethod: paymentMethod,
                    sessionCycle: paymentMethod === 'session' ? Number(sessionCycle) : null,
                    fee: parseInt(getEl('studentFee').value) || 0
                };

                if (currentEditingStudentId) {
                    const index = students.findIndex(s => s.id === currentEditingStudentId);
                    const oldStudent = students[index];
                    students[index] = { ...oldStudent, ...formData };
                } else {
                    const newId = students.length > 0 ? Math.max(...students.map(s => s.id)) + 1 : 1;
                    const newStudent = { 
                        id: newId, 
                        ...formData, 
                        color: G_COLOR_PALETTE[(newId - 1) % G_COLOR_PALETTE.length],
                        totalClassesCount: 0,
                        unpaidMonths: []
                    };
                    students.push(newStudent);
                }
                saveData();
                renderStudents();
                renderStudentFilter();
                closeModal(studentModal);
            });

            classForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedCheckboxes = queryAll('#classStudentCheckboxes input:checked');
                const newStudentIds = Array.from(selectedCheckboxes).map(cb => Number(cb.value));
                
                if (newStudentIds.length === 0) {
                    alert('한 명 이상의 학생을 선택해주세요.');
                    return;
                }

                if(currentEditingClassId) { // Editing
                    const classIndex = classes.findIndex(c => c.id === currentEditingClassId);
                    const originalStudentIds = classes[classIndex].studentIds;

                    const addedIds = newStudentIds.filter(id => !originalStudentIds.includes(id));
                    const removedIds = originalStudentIds.filter(id => !newStudentIds.includes(id));

                    addedIds.forEach(id => {
                        const student = students.find(s => s.id === id);
                        if (student && student.paymentMethod === 'session') student.totalClassesCount++;
                    });
                    removedIds.forEach(id => {
                        const student = students.find(s => s.id === id);
                        if (student && student.paymentMethod === 'session') student.totalClassesCount--;
                    });
                    
                    classes[classIndex] = {
                        ...classes[classIndex],
                        time: getEl('classTime').value,
                        studentIds: newStudentIds,
                        memo: getEl('classMemo').value.trim(),
                        homework: getEl('classHomework').value.trim()
                    };

                } else { // Adding
                    newStudentIds.forEach(studentId => {
                        const student = students.find(s => s.id === studentId);
                        if (student && student.paymentMethod === 'session') {
                            student.totalClassesCount = (student.totalClassesCount || 0) + 1;
                        }
                    });

                    const newClass = {
                        id: classes.length > 0 ? Math.max(...classes.map(c => c.id)) + 1 : 1,
                        date: getEl('classDate').value,
                        time: getEl('classTime').value,
                        studentIds: newStudentIds,
                        memo: getEl('classMemo').value.trim(),
                        homework: getEl('classHomework').value.trim()
                    };
                    classes.push(newClass);
                }
                
                saveData();
                renderClassesForDate(selectedDate);
                renderStudents();
                closeModal(classModal);
            });

            exportDataBtn.addEventListener('click', () => {
                if(students.length === 0 && classes.length === 0) {
                    alert('백업할 데이터가 없습니다.');
                    return;
                }
                const backupData = { students, classes };
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date();
                const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                a.download = `tutoring-log-backup-${dateString}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            importDataBtn.addEventListener('click', () => importDataInput.click());
            importDataInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!confirm('정말로 데이터를 복원하시겠습니까? 현재 모든 기록이 선택한 파일의 내용으로 대체됩니다! 이 작업은 되돌릴 수 없습니다.')) {
                    e.target.value = null;
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        if (Array.isArray(backupData.students) && Array.isArray(backupData.classes)) {
                            students = backupData.students;
                            classes = backupData.classes;
                            saveData();
                            alert('데이터를 성공적으로 복원했습니다.');
                            initializeApp();
                        } else {
                            alert('잘못된 형식의 백업 파일입니다.');
                        }
                    } catch (error) {
                        alert('파일을 읽는 중 오류가 발생했습니다.');
                        console.error("Import error:", error);
                    } finally {
                        e.target.value = null;
                    }
                };
                reader.readAsText(file);
            });

            queryAll('.close-btn, .btn-cancel').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = getEl(btn.dataset.modal);
                    closeModal(modal);
                });
            });
            
            queryAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
            });

            initializeApp();
        });
    </script>
</body>
</html>
